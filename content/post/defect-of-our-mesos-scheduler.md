+++
date = "2018-06-25T08:36:54-07:00"
title = "mesos-scheduler 现有缺陷"
tags = ["mesos", "scheduler"]
draft = false
+++

基于mesos一套基础架构之下，一些生产维护期间总结的问题和经验。

<!--more-->

# mesos-scheduler 现有缺陷

基于mesos一套基础架构之下，一些生产维护期间总结的问题和经验。

##### 支持高可用



##### 完美支持排空


* 针对`app`层面的排空
* 针对`machine`层面的排空



##### 碎片化资源 导致大实例分配不到合适的资源


* 目前只知道 `task` 的分布情况，不清楚各个 agent 机器上的资源分布
* 需要掌握各个agent上的资源分布，这样才能对资源进行 "二次调度"



##### 某些 cpu 消耗密集型实例分配过于集中


* 该问题也属于上个问题中的 "二次调度"




##### 高可用


* 高可用 http://mesos.apache.org/documentation/latest/high-availability-framework-guide/




##### 清理无效的资源


* 被抛弃的launch信息，主要是来自于中环的失效 release 造成的。
* "退休"的docker image占用磁盘



##### 自动升级实例版本


* 提供 1-2 个升级策略：比如 启动一个新版本后删除一个旧版本，或启动完新版本后删除所有旧版本



##### 内部信息快照展示 


* 比如说多少 task 正在队列中等待资源，哪些任务正在执行等



##### （option）新版的 mesos 支持了健康检查 


* 如果在 mesos 接受健康信息后 对服务发现组件做个回调就能及时同步健康状态
* 这个回调对 consul 而言就做不到



##### 针对实例状态(Staging，Running，Failed)提供具体的Reason


* 对实例各种状态提供Reason，可以将实例为什么进入该状态提供信息



##### 延迟调度 针对短时间内连续重启的实例


* 现在的做法太"七牛"，以后应该做一些通用的设置，比如延迟策略，支持创建实例时候自主选择



#####  提供从容器外读取配置文件


* 支持将配置文件和容器镜像分离，支持对配置文件的更新，这样不用重新发布容器镜像（即app版本）
* 初步考虑从 consul kv 中读取



##### 需要一个智能的 mock-master


* 该 mock-master 与 framework 对发请求，mock-master 也能智能随机产生各种 Event(Update, Failure, Message, Heartbeat等)，并能拥有一批虚拟的 agent 节点，发布一系列虚拟的 task，可以让 framework 模拟掌控一个虚拟集群的效果



##### 对一次性扩缩容加以限制，防止手贱



##### 支持多种任务调度，比如replica set、job等



##### 显示解注册服务失败的记录


* 解注册时候可能因为服务发现组件的问题而失败，也有可能是网络问题



##### 即使使用了新版的 mesos-go sdk 当发生 mesos-master 主从切换时 仍有问题


* 假设之前跟老 leader 连接，突然老 leader 挂了，那么 scheduler 会持续对老 leader 发起请求。如果老 leader 起来了，那么老 leader 返回新 leader 的地址（根据response 中的 Location），但是老 leader 没起来，这就尴尬了。



##### 保证服务可靠性的自动升级


针对一些长耗时的请求，如果请求带有重试功能，在服务升级中过程中，有可能请求会重试到被升级的实例上，导致请求失败。考虑在升级过程中，将那些老的实例定义为一种亚健康状态（不稳定状态，随时有可能消失，当然前提是基于mesos实现的健康检查），那么重试时候尽量减少或不会重试到这些亚健康的实例上。
